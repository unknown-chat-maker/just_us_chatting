<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ghost Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Custom Font & Animations */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pitch Black */
            color: white;
            overflow: hidden; /* Prevent body scroll, handle in chat container */
            touch-action: manipulation;
        }

        /* The Lock Screen Curtain */
        #lock-screen {
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 50;
        }
        .unlocked {
            transform: translateY(-100%);
        }

        /* Message Bubbles */
        .msg-bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 20px;
            margin-bottom: 8px;
            position: relative;
            word-wrap: break-word;
            font-size: 15px;
            animation: bounceIn 0.4s ease-out;
        }

        .msg-me {
            background: linear-gradient(135deg, #8B5CF6, #EC4899); /* Deep Purple to Pink */
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
        }

        .msg-other {
            background-color: #1F1F1F;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* Animations */
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.9) translateY(10px); }
            70% { transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Hide Scrollbar but allow scroll */
        #chat-container::-webkit-scrollbar {
            display: none;
        }
        #chat-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom Input Styling */
        .glass-input {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <div id="lock-screen" class="absolute inset-0 bg-black flex flex-col items-center justify-center">
        <div class="mb-8 text-6xl">üëª</div>
        <h1 class="text-2xl font-bold mb-6 text-gray-300 tracking-widest">GHOST VAULT</h1>
        <input type="password" id="pin-input" maxlength="6" 
               class="bg-gray-900 text-white text-center text-2xl tracking-[10px] p-4 rounded-xl border border-gray-700 focus:outline-none focus:border-purple-500 w-64"
               placeholder="******">
        <p id="error-msg" class="text-red-500 mt-4 hidden">Access Denied</p>
    </div>

    <div class="flex items-center justify-between px-4 py-3 bg-black border-b border-gray-800 z-10">
        <div class="flex items-center gap-3" onclick="toggleIdentity()" style="cursor: pointer;">
            <div id="header-avatar" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-xl border border-gray-700">
                üê∑
            </div>
            <div>
                <h2 id="header-name" class="font-bold text-sm">Piggy</h2>
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-xs text-gray-400">Active now</span>
                </div>
            </div>
        </div>
        <button onclick="exportData()" class="p-2 text-gray-400 hover:text-white">
            üì•
        </button>
    </div>

    <div id="chat-container" class="flex-1 flex flex-col gap-2 p-4 overflow-y-auto bg-black">
        <div class="text-center text-xs text-gray-600 mt-4 mb-8">Messages are stored locally & encrypted.</div>
    </div>

    <div class="p-3 bg-black border-t border-gray-800 flex items-end gap-2 pb-safe">
        <input type="file" id="media-input" accept="image/*,video/*" class="hidden" onchange="handleMediaUpload(this)">
        <button onclick="document.getElementById('media-input').click()" class="p-3 text-purple-400 hover:text-purple-300">
            üì∑
        </button>
        
        <textarea id="msg-input" rows="1" 
                  class="glass-input flex-1 text-white rounded-2xl px-4 py-3 focus:outline-none resize-none" 
                  placeholder="Message..." 
                  style="min-height: 48px; max-height: 120px;"></textarea>
        
        <button id="send-btn" class="p-3 bg-purple-600 rounded-full text-white hover:bg-purple-500 transition-colors shadow-lg shadow-purple-900/50">
            ‚û§
        </button>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const PIN_CODE = "112011";
        const DB_NAME = "GhostVaultDB";
        const DB_VERSION = 1;
        
        // State
        let currentUser = "pig"; // 'pig' (üê∑) or 'sweet' (üçß)
        let db;

        // --- 2. INDEXEDDB SETUP (Unlimited Storage) ---
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            const objectStore = db.createObjectStore("messages", { keyPath: "id", autoIncrement: true });
            objectStore.createIndex("timestamp", "timestamp", { unique: false });
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            loadMessages(); // Load history when DB is ready
        };

        request.onerror = function(event) {
            console.error("Database error: " + event.target.errorCode);
        };

        function saveMessage(text, mediaBlob, type) {
            const transaction = db.transaction(["messages"], "readwrite");
            const objectStore = transaction.objectStore("messages");
            
            const msg = {
                text: text,
                media: mediaBlob, // Stores the actual file blob
                mediaType: type, // 'image' or 'video' or null
                sender: currentUser,
                timestamp: new Date().getTime()
            };

            const request = objectStore.add(msg);
            request.onsuccess = function() {
                renderMessage(msg);
                scrollToBottom();
            };
        }

        // --- 3. UI LOGIC ---

        // Lock Screen
        const pinInput = document.getElementById('pin-input');
        pinInput.addEventListener('input', (e) => {
            if (e.target.value === PIN_CODE) {
                document.getElementById('lock-screen').classList.add('unlocked');
                pinInput.blur(); // Dismiss keyboard on unlock
                setTimeout(() => scrollToBottom(), 600);
            } else if (e.target.value.length === 6) {
                document.getElementById('error-msg').classList.remove('hidden');
                setTimeout(() => {
                    pinInput.value = '';
                    document.getElementById('error-msg').classList.add('hidden');
                }, 1000);
            }
        });

        // Identity Switcher (Clicking the header icon)
        function toggleIdentity() {
            currentUser = currentUser === "pig" ? "sweet" : "pig";
            updateHeader();
        }

        function updateHeader() {
            const avatar = document.getElementById('header-avatar');
            const name = document.getElementById('header-name');
            
            if (currentUser === "pig") {
                avatar.innerText = "üê∑";
                name.innerText = "Piggy";
            } else {
                avatar.innerText = "üçß";
                name.innerText = "Rasmalai";
            }
        }

        // Render Message to DOM
        function renderMessage(msg) {
            const container = document.getElementById('chat-container');
            const isMe = msg.sender === currentUser; // Dynamic check based on who is currently logged in? 
            // NOTE: For a shared vault feel, we render based on who sent it vs who "I" am currently acting as.
            
            const div = document.createElement('div');
            // Logic: If I am currently Piggy, and the message was sent by Piggy, it's "msg-me".
            const alignClass = (msg.sender === currentUser) ? 'msg-me' : 'msg-other';
            
            div.className = `msg-bubble ${alignClass} flex flex-col`;

            // Media
            if (msg.media) {
                const url = URL.createObjectURL(msg.media);
                if (msg.mediaType === 'video') {
                    div.innerHTML += `<video src="${url}" controls class="rounded-lg max-w-full mb-2 border border-white/10"></video>`;
                } else {
                    div.innerHTML += `<img src="${url}" class="rounded-lg max-w-full mb-2 border border-white/10" loading="lazy">`;
                }
            }

            // Text
            if (msg.text) {
                div.innerHTML += `<span>${msg.text}</span>`;
            }

            // Timestamp (Tiny)
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            div.innerHTML += `<div class="text-[10px] opacity-50 text-right mt-1 w-full">${time}</div>`;

            container.appendChild(div);
        }

        function loadMessages() {
            const transaction = db.transaction(["messages"], "readonly");
            const objectStore = transaction.objectStore("messages");
            const request = objectStore.getAll();

            request.onsuccess = function(event) {
                const container = document.getElementById('chat-container');
                container.innerHTML = '<div class="text-center text-xs text-gray-600 mt-4 mb-8">Messages are stored locally & encrypted.</div>'; // Reset
                const messages = event.target.result;
                messages.forEach(msg => {
                    // Visual rendering trick: We need to decide if it's Left or Right based on the *current* identity?
                    // Actually, usually chat history is static. Pig is always Right if I am Pig.
                    // To keep it simple: Messages sent by "pig" are Right if currentUser is "pig".
                    // Messages sent by "pig" are Left if currentUser is "sweet".
                    
                    const isSender = (msg.sender === currentUser);
                    const alignClass = isSender ? 'msg-me' : 'msg-other';
                    
                    const div = document.createElement('div');
                    div.className = `msg-bubble ${alignClass} flex flex-col`;

                    if (msg.media) {
                        const url = URL.createObjectURL(msg.media);
                         if (msg.mediaType === 'video') {
                            div.innerHTML += `<video src="${url}" controls class="rounded-lg max-w-full mb-2 border border-white/10"></video>`;
                        } else {
                            div.innerHTML += `<img src="${url}" class="rounded-lg max-w-full mb-2 border border-white/10" loading="lazy">`;
                        }
                    }
                    if (msg.text) div.innerHTML += `<span>${msg.text}</span>`;
                    
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    div.innerHTML += `<div class="text-[10px] opacity-50 text-right mt-1 w-full">${time}</div>`;

                    container.appendChild(div);
                });
                scrollToBottom();
            };
        }

        // --- 4. SENDING LOGIC (The "Stay Open" Trick) ---
        const sendBtn = document.getElementById('send-btn');
        const msgInput = document.getElementById('msg-input');

        // Prevent default touch behavior on Send button to stop keyboard from closing
        sendBtn.addEventListener('mousedown', (e) => {
            e.preventDefault(); // This is the magic line
        });
        
        sendBtn.addEventListener('click', sendMessage);

        function sendMessage() {
            const text = msgInput.value.trim();
            if (!text) return;

            saveMessage(text, null, null);
            msgInput.value = '';
            
            // Force focus back immediately to keep keyboard up
            msgInput.focus(); 
        }

        // Handle Media
        function handleMediaUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const type = file.type.startsWith('video') ? 'video' : 'image';
            saveMessage("", file, type); // Save blob directly
            input.value = ''; // Reset
        }

        // Scroll helper
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }
        
        // Auto-resize textarea
        msgInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // --- 5. EXPORT LOGIC (Manual Sync) ---
        async function exportData() {
            const zip = new JSZip();
            const transaction = db.transaction(["messages"], "readonly");
            const objectStore = transaction.objectStore("messages");
            const request = objectStore.getAll();

            request.onsuccess = async function(event) {
                const messages = event.target.result;
                let chatLog = "TIMESTAMP | SENDER | MESSAGE\n----------------------------------\n";
                
                const mediaFolder = zip.folder("media");

                messages.forEach((msg, index) => {
                    const time = new Date(msg.timestamp).toLocaleString();
                    let mediaRef = "";
                    
                    if (msg.media) {
                        const ext = msg.mediaType === 'video' ? 'mp4' : 'jpg';
                        const filename = `msg_${index}_${msg.timestamp}.${ext}`;
                        mediaFolder.file(filename, msg.media);
                        mediaRef = `[Attachment: media/${filename}]`;
                    }
                    
                    chatLog += `${time} | ${msg.sender} | ${msg.text} ${mediaRef}\n`;
                });

                zip.file("chat_history.txt", chatLog);

                const content = await zip.generateAsync({type:"blob"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = `GhostVault_Export_${new Date().toISOString().slice(0,10)}.zip`;
                a.click();
            };
        }

        // Initialize
        updateHeader();

    </script>
</body>
</html>
