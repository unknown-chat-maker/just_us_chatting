<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Logs</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Hidden Screens */
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; }
        
        /* Video Call UI */
        #call-ui { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 30%; border-radius: 10px; border: 2px solid #fff; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .call-bar { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; }

        /* Fullscreen Media Viewer */
        #viewer { display: none; position: fixed; inset: 0; background: rgba(0,0,0,1); z-index: 2000; justify-content: center; align-items: center; }
        #viewer img, #viewer video { max-width: 100%; max-height: 100%; }

        /* Chat UI */
        .header { padding: 15px; background: #111; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 18px; max-width: 80%; font-size: 15px; line-height: 1.4; }
        .me { background: #a020f0; align-self: flex-end; border-bottom-right-radius: 4px; }
        .them { background: #262626; align-self: flex-start; border-bottom-left-radius: 4px; }
        
        .footer { padding: 12px; display: flex; gap: 10px; background: #000; border-top: 1px solid #222; align-items: center; }
        input[type="text"] { flex: 1; background: #1a1a1a; border: none; color: white; padding: 12px; border-radius: 25px; outline: none; }
        button { cursor: pointer; border: none; background: none; color: white; font-weight: bold; }
    </style>
</head>
<body>

    <div id="lock-screen" class="screen" style="display: flex; justify-content: center; align-items: center; padding: 40px;">
        <div style="width: 100%; text-align: center;">
            <input type="password" id="pin" style="width:100%; padding:18px; background: #111; border: 1px solid #333; color: white; border-radius: 12px; text-align: center; font-size: 20px;" placeholder="LOG IN">
            <button onclick="unlock()" style="margin-top: 25px; padding: 15px 50px; background: #a020f0; border-radius: 30px;">AUTHENTICATE</button>
        </div>
    </div>

    <div id="main-app" class="screen">
        <div class="header">
            <span style="font-weight: bold; color: #a020f0;">SECURE LOGS</span>
            <div style="display: flex; gap: 20px; align-items: center;">
                <button onclick="exportAll()" title="Export Media">ðŸ“¥</button>
                <button onclick="placeCall()" style="font-size: 22px;">ðŸ“ž</button>
            </div>
        </div>

        <div id="chat-box" class="chat-area"></div>

        <div class="footer">
            <input type="file" id="media-input" hidden accept="image/*,video/*" onchange="uploadFile(this)">
            <button onclick="document.getElementById('media-input').click()" style="font-size: 24px;">ðŸ“Ž</button>
            <input type="text" id="msg-input" placeholder="Secure message...">
            <button onclick="sendText()" style="color: #a020f0; font-size: 16px;">SEND</button>
        </div>
    </div>

    <div id="call-ui">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-bar">
            <button onclick="endCall()" style="background: #ff3b30; color: white; padding: 15px 50px; border-radius: 40px; font-size: 18px;">END CALL</button>
        </div>
    </div>

    <div id="viewer" onclick="this.style.display='none'"></div>

    <script>
        const PASSCODE = "112011";
        const MY_USER_ID = "pig-2026"; // Change to 'rasmalai-2026' on the other phone
        const TARGET_ID = (MY_USER_ID === "pig-2026") ? "rasmalai-2026" : "pig-2026";
        
        let db;
        const peer = new Peer(MY_USER_ID);

        // Initialize Database (IndexedDB)
        const request = indexedDB.open("SecureVault", 1);
        request.onupgradeneeded = e => e.target.result.createObjectStore("messages", { keyPath: "id", autoIncrement: true });
        request.onsuccess = e => { db = e.target.result; renderChat(); };

        function unlock() {
            if(document.getElementById('pin').value === PASSCODE) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                renderChat();
            }
        }

        // --- Video Call Logic ---
        peer.on('call', async call => {
            if(confirm("Accept incoming video call?")) {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('call-ui').style.display = 'block';
                document.getElementById('local-video').srcObject = stream;
                call.answer(stream);
                call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
            }
        });

        async function placeCall() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('call-ui').style.display = 'block';
                document.getElementById('local-video').srcObject = stream;
                const call = peer.call(TARGET_ID, stream);
                call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
            } catch(e) { alert("Camera access denied or user offline."); }
        }

        function endCall() { location.reload(); }

        // --- Chat & Hidden Storage ---
        function sendText() {
            const val = document.getElementById('msg-input').value;
            if(!val) return;
            saveToDB({ type: 'text', data: val, sender: 'me' });
            document.getElementById('msg-input').value = '';
        }

        function uploadFile(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = e => {
                const type = file.type.startsWith('image') ? 'img' : 'vid';
                saveToDB({ type: type, data: e.target.result, sender: 'me' });
            };
            reader.readAsDataURL(file);
        }

        function saveToDB(obj) {
            const tx = db.transaction("messages", "readwrite");
            tx.objectStore("messages").add({ ...obj, time: Date.now() });
            tx.oncomplete = renderChat;
        }

        function renderChat() {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            const tx = db.transaction("messages", "readonly");
            tx.objectStore("messages").getAll().onsuccess = e => {
                e.target.result.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `msg ${m.sender === 'me' ? 'me' : 'them'}`;
                    if(m.type === 'text') div.innerText = m.data;
                    else if(m.type === 'img') div.innerHTML = `<img src="${m.data}" style="width:100%; border-radius:10px;" onclick="openFull('${m.data}', 'img')">`;
                    else div.innerHTML = `<video src="${m.data}" style="width:100%; border-radius:10px;" onclick="openFull('${m.data}', 'vid')"></video>`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            };
        }

        function openFull(src, type) {
            const v = document.getElementById('viewer');
            v.innerHTML = type === 'img' ? `<img src="${src}">` : `<video src="${src}" controls autoplay></video>`;
            v.style.display = 'flex';
        }

        // --- Export Media (ZIP) ---
        async function exportAll() {
            const zip = new JSZip();
            const tx = db.transaction("messages", "readonly");
            tx.objectStore("messages").getAll().onsuccess = async e => {
                let mediaCount = 0;
                for(let m of e.target.result) {
                    if(m.type !== 'text') {
                        const blob = await (await fetch(m.data)).blob();
                        const ext = m.type === 'img' ? 'jpg' : 'mp4';
                        zip.file(`vault_${m.time}.${ext}`, blob);
                        mediaCount++;
                    }
                }
                if(mediaCount > 0) {
                    zip.generateAsync({type:"blob"}).then(content => saveAs(content, "Vault_Media.zip"));
                } else { alert("No media to export."); }
            };
        }
    </script>
</body>
</html>
