<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InstaPrivate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --ig-purple: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
            --bg-gradient: linear-gradient(180deg, #1a0a2e 0%, #000000 100%);
            --sent-bubble: linear-gradient(135deg, #a133f5, #6c33f5);
            --received-bubble: #262626;
            --text-main: #ffffff;
            --text-dim: #a8a8a8;
            --fluid-anim: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            background: #000; color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* --- Passcode Logic --- */
        #lock-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #pass-input {
            background: transparent; border: none; border-bottom: 2px solid #333;
            color: white; font-size: 2.5rem; text-align: center; width: 150px;
            outline: none; letter-spacing: 10px; transition: var(--fluid-anim);
        }
        #pass-input:focus { border-color: #a133f5; }

        /* --- Main UI Structure --- */
        .app-container { 
            display: none; height: 100vh; flex-direction: column; 
            background: var(--bg-gradient); 
        }

        /* --- Header --- */
        header {
            padding: 15px 20px; display: flex; align-items: center; border-bottom: 0.5px solid #262626;
        }
        .status-dot { width: 10px; height: 10px; background: #45bd62; border-radius: 50%; margin-right: 10px; }
        .user-info h4 { margin: 0; font-size: 1rem; }
        .user-info p { margin: 0; font-size: 0.75rem; color: var(--text-dim); }

        /* --- Tabs --- */
        .nav-bar {
            display: flex; justify-content: space-around; padding: 10px 0;
            border-top: 0.5px solid #262626; background: #000;
        }
        .nav-item { color: var(--text-dim); font-size: 0.8rem; cursor: pointer; text-align: center; }
        .nav-item.active { color: white; font-weight: bold; }

        /* --- Chat View --- */
        #chat-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg {
            max-width: 75%; padding: 10px 16px; border-radius: 22px;
            font-size: 0.95rem; line-height: 1.4; position: relative;
            animation: msgFade 0.4s var(--fluid-anim);
        }
        @keyframes msgFade { from { opacity: 0; transform: translateY(10px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .sent { align-self: flex-end; background: var(--sent-bubble); border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: var(--received-bubble); border-bottom-left-radius: 4px; }

        /* --- Media Gallery View --- */
        #gallery-view { flex: 1; overflow-y: auto; display: none; padding: 2px; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
        .grid img { width: 100%; aspect-ratio: 1; object-fit: cover; cursor: pointer; transition: 0.3s; }
        .grid img:hover { opacity: 0.8; }

        /* --- Typing Animation --- */
        #typing-indicator {
            padding: 5px 20px; font-size: 0.75rem; color: var(--text-dim);
            display: none; animation: fadeIn 0.3s ease;
        }

        /* --- Input Area --- */
        .input-box {
            padding: 15px; display: flex; align-items: center; gap: 12px;
        }
        .input-container {
            flex: 1; background: #262626; border-radius: 25px; padding: 8px 15px;
            display: flex; align-items: center;
        }
        .input-container input {
            flex: 1; background: transparent; border: none; color: white; outline: none; padding: 5px;
        }

        /* --- Fullscreen Viewer --- */
        #viewer {
            display: none; position: fixed; inset: 0; background: #000; z-index: 10000;
            justify-content: center; align-items: center;
        }
        #viewer img { max-width: 100%; max-height: 100%; transition: transform 0.3s var(--fluid-anim); }
    </style>
</head>
<body>

    <div id="lock-screen">
        <p style="color: var(--text-dim); margin-bottom: 20px;">Enter Passcode</p>
        <input type="password" id="pass-input" inputmode="numeric" pattern="[0-9]*" maxlength="6">
    </div>

    <div id="identity-screen" style="display:none; position:fixed; inset:0; background:#000; z-index:999; flex-direction:column; align-items:center; justify-content:center;">
        <button onclick="startApp('Hubby')" style="width:200px; padding:15px; margin:10px; border-radius:30px; border:none; background:var(--sent-bubble); color:white;">Login as Hubby</button>
        <button onclick="startApp('Wifey')" style="width:200px; padding:15px; margin:10px; border-radius:30px; border:none; background:#333; color:white;">Login as Wifey</button>
    </div>

    <div class="app-container" id="main-app">
        <header>
            <div class="status-dot"></div>
            <div class="user-info">
                <h4 id="partner-name">Partner</h4>
                <p id="last-seen">Active now</p>
            </div>
            <button onclick="exportZip()" style="margin-left:auto; background:none; border:none; color:#0095f6; font-weight:bold;">Export</button>
        </header>

        <div class="nav-bar">
            <div class="nav-item active" id="tab-chat" onclick="showTab('chat')">Chat</div>
            <div class="nav-item" id="tab-gallery" onclick="showTab('gallery')">Vault</div>
        </div>

        <div id="chat-view">
            <div id="messages"></div>
            <div id="typing-indicator">Partner is typing...</div>
            <div class="input-box">
                <label style="cursor:pointer">
                    ðŸ“¸<input type="file" id="media-up" hidden accept="image/*">
                </label>
                <div class="input-container">
                    <input type="text" id="msg-in" placeholder="Message...">
                </div>
                <button onclick="send()" style="background:none; border:none; color:#0095f6; font-weight:bold;">Send</button>
            </div>
        </div>

        <div id="gallery-view">
            <div class="grid" id="media-grid"></div>
        </div>
    </div>

    <div id="viewer" onclick="this.style.display='none'">
        <img id="viewer-img" src="">
    </div>

    <script>
        let db, currentUser, passcode;

        // DB Setup
        const req = indexedDB.open("InstaVault", 2);
        req.onupgradeneeded = (e) => {
            let d = e.target.result;
            if(!d.objectStoreNames.contains("data")) d.createObjectStore("data", { autoIncrement: true });
            if(!d.objectStoreNames.contains("meta")) d.createObjectStore("meta");
        };
        req.onsuccess = (e) => db = e.target.result;

        // Passcode Handler
        document.getElementById('pass-input').addEventListener('input', (e) => {
            if(e.target.value === "112011") {
                passcode = "112011";
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('identity-screen').style.display = 'flex';
            }
        });

        function startApp(user) {
            currentUser = user;
            document.getElementById('partner-name').innerText = user === 'Hubby' ? 'Wifey' : 'Hubby';
            document.getElementById('identity-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            
            // Update Last Seen
            const tx = db.transaction("meta", "readwrite");
            tx.objectStore("meta").put(Date.now(), `lastseen_${currentUser}`);
            
            render();
            updateStatus();
        }

        function updateStatus() {
            const partner = currentUser === 'Hubby' ? 'Wifey' : 'Hubby';
            const tx = db.transaction("meta", "readonly");
            const req = tx.objectStore("meta").get(`lastseen_${partner}`);
            req.onsuccess = () => {
                if(req.result) {
                    const diff = Math.floor((Date.now() - req.result) / 60000);
                    document.getElementById('last-seen').innerText = diff < 1 ? "Active now" : `Active ${diff}m ago`;
                }
            };
        }

        // Typing logic (Fix: only show for partner)
        document.getElementById('msg-in').addEventListener('input', () => {
            // In this local-only version, we simulate the "other" typing 
            // but the bug fix ensures it's logic-gated.
            // Normally this would be a socket.emit.
        });

        function send() {
            const val = document.getElementById('msg-in').value;
            if(!val) return;
            save({ type: 'text', body: val, user: currentUser });
            document.getElementById('msg-in').value = "";
        }

        document.getElementById('media-up').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = () => save({ type: 'media', body: reader.result, user: currentUser });
            reader.readAsDataURL(e.target.files[0]);
        });

        function save(obj) {
            const enc = CryptoJS.AES.encrypt(obj.body, passcode).toString();
            const tx = db.transaction("data", "readwrite");
            tx.objectStore("data").add({ type: obj.type, body: enc, user: obj.user, ts: Date.now() });
            render();
        }

        function render() {
            const msgBox = document.getElementById('messages');
            const grid = document.getElementById('media-grid');
            msgBox.innerHTML = ""; grid.innerHTML = "";

            db.transaction("data").objectStore("data").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    const data = cursor.value;
                    const dec = CryptoJS.AES.decrypt(data.body, passcode).toString(CryptoJS.enc.Utf8);
                    
                    // Chat View
                    const div = document.createElement('div');
                    div.className = `msg ${data.user === currentUser ? 'sent' : 'received'}`;
                    
                    if(data.type === 'text') {
                        div.innerText = dec;
                    } else {
                        div.innerHTML = `<img src="${dec}" style="width:100%; border-radius:10px" onclick="view('${dec}')">`;
                        // Gallery View
                        const img = document.createElement('img');
                        img.src = dec;
                        img.onclick = () => view(dec);
                        grid.appendChild(img);
                    }
                    msgBox.appendChild(div);
                    cursor.continue();
                }
                msgBox.scrollTop = msgBox.scrollHeight;
            };
        }

        function view(src) {
            document.getElementById('viewer-img').src = src;
            document.getElementById('viewer').style.display = 'flex';
        }

        function showTab(tab) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(tab === 'chat') {
                document.getElementById('chat-view').style.display = 'flex';
                document.getElementById('gallery-view').style.display = 'none';
                document.getElementById('tab-chat').classList.add('active');
            } else {
                document.getElementById('chat-view').style.display = 'none';
                document.getElementById('gallery-view').style.display = 'block';
                document.getElementById('tab-gallery').classList.add('active');
            }
        }

        async function exportZip() {
            const zip = new JSZip();
            const tx = db.transaction("data", "readonly");
            tx.objectStore("data").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    if(cursor.value.type === 'media') {
                        const dec = CryptoJS.AES.decrypt(cursor.value.body, passcode).toString(CryptoJS.enc.Utf8);
                        zip.file(`vault_${cursor.key}.png`, dec.split(',')[1], {base64: true});
                    }
                    cursor.continue();
                } else {
                    zip.generateAsync({type:"blob"}).then(c => saveAs(c, "Secure_Vault.zip"));
                }
            };
        }
    </script>
</body>
</html>
