<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Logs</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Video Call UI */
        #call-ui { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 30%; border-radius: 10px; border: 2px solid #fff; }
        .call-bar { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; }

        /* Fullscreen Media */
        #viewer { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        #viewer img { max-width: 100%; max-height: 100%; }

        /* Chat UI */
        .header { padding: 15px; background: #111; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { padding: 12px; margin-bottom: 8px; border-radius: 15px; max-width: 80%; }
        .me { background: #a020f0; align-self: flex-end; }
        .them { background: #262626; align-self: flex-start; }
        .footer { padding: 10px; display: flex; gap: 10px; border-top: 1px solid #222; }
        input { flex: 1; background: #1a1a1a; border: none; color: white; padding: 12px; border-radius: 20px; }
    </style>
</head>
<body>

    <div class="header">
        <span id="status" style="font-size: 12px; color: #555;">Connecting...</span>
        <div>
            <button onclick="exportMedia()" style="background:none; border:none; margin-right:15px;">ðŸ“¥</button>
            <button onclick="placeCall()" style="background:none; border:none; font-size: 20px;">ðŸ“ž</button>
        </div>
    </div>

    <div id="chat-box" class="chat-area"></div>

    <div class="footer">
        <input type="file" id="media-up" hidden onchange="upload(this)">
        <button onclick="document.getElementById('media-up').click()" style="background:none; border:none;">ðŸ“Ž</button>
        <input type="text" id="text-in" placeholder="Type message...">
        <button onclick="send()" style="background:none; border:none; color:#a020f0; font-weight:bold;">SEND</button>
    </div>

    <div id="call-ui">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-bar">
            <button onclick="endCall()" style="background:red; color:white; border:none; padding:15px 40px; border-radius:30px;">END</button>
        </div>
    </div>

    <div id="viewer" onclick="this.style.display='none'"></div>

    <script>
        let db;
        // CHANGE THIS ON EACH PHONE: 'pig-vault-2026' or 'rasmalai-vault-2026'
        const MY_ID = 'pig-vault-2026'; 
        const PEER_ID = (MY_ID === 'pig-vault-2026') ? 'rasmalai-vault-2026' : 'pig-vault-2026';

        // 1. AUTO-SAVE (IndexedDB)
        const req = indexedDB.open("LocalVault", 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore("msgs", {keyPath:"id", autoIncrement:true});
        req.onsuccess = e => { db = e.target.result; load(); };

        // 2. CALLING LOGIC (PeerJS)
        const peer = new Peer(MY_ID);
        peer.on('open', id => document.getElementById('status').innerText = "Online: " + id);
        
        // Receiving a call
        peer.on('call', async call => {
            if(confirm("Incoming Call from " + PEER_ID)) {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('call-ui').style.display = 'block';
                document.getElementById('local-video').srcObject = stream;
                call.answer(stream);
                call.on('stream', remoteStream => {
                    document.getElementById('remote-video').srcObject = remoteStream;
                });
            }
        });

        async function placeCall() {
            const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('call-ui').style.display = 'block';
            document.getElementById('local-video').srcObject = stream;
            
            const call = peer.call(PEER_ID, stream);
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
        }

        function endCall() { location.reload(); }

        // 3. CHAT & MEDIA
        function send() {
            const val = document.getElementById('text-in').value;
            if(!val) return;
            const tx = db.transaction("msgs", "readwrite");
            tx.objectStore("msgs").add({ type: 'text', data: val, sender: 'me' });
            document.getElementById('text-in').value = '';
            tx.oncomplete = load;
        }

        function upload(el) {
            const reader = new FileReader();
            reader.onload = e => {
                const tx = db.transaction("msgs", "readwrite");
                tx.objectStore("msgs").add({ type: 'img', data: e.target.result, sender: 'me' });
                tx.oncomplete = load;
            };
            reader.readAsDataURL(el.files[0]);
        }

        function load() {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            db.transaction("msgs").objectStore("msgs").getAll().onsuccess = e => {
                e.target.result.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `msg ${m.sender === 'me' ? 'me' : 'them'}`;
                    if(m.type === 'text') div.innerText = m.data;
                    else div.innerHTML = `<img src="${m.data}" style="width:100%; border-radius:10px;" onclick="view('${m.data}')">`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            };
        }

        function view(src) {
            const v = document.getElementById('viewer');
            v.innerHTML = `<img src="${src}">`;
            v.style.display = 'flex';
        }

        async function exportMedia() {
            const zip = new JSZip();
            db.transaction("msgs").objectStore("msgs").getAll().onsuccess = async e => {
                for(let m of e.target.result) {
                    if(m.type === 'img') {
                        const blob = await (await fetch(m.data)).blob();
                        zip.file(`img_${Date.now()}.jpg`, blob);
                    }
                }
                zip.generateAsync({type:"blob"}).then(b => saveAs(b, "media_export.zip"));
            };
        }
    </script>
</body>
</html>
