<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title> </title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --ig-purple: #a020f0;
            --ig-grad: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            --bg-black: #000000;
            --surface: #121212;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg-black); color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* Lock Screen - Hyper Minimal */
        #lock { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: 0.5s ease-in-out; }
        #pin { background: none; border: none; border-bottom: 1px solid #333; color: white; text-align: center; font-size: 28px; width: 150px; outline: none; letter-spacing: 8px; }

        /* Instagram Style Header */
        .header { height: 60px; display: flex; align-items: center; justify-content: flex-end; padding: 0 20px; border-bottom: 0.5px solid #262626; background: #000; }
        .nav-icon { background: none; border: none; color: white; font-size: 22px; margin-left: 20px; cursor: pointer; opacity: 0.8; }

        /* Chat area with Instagram Bubbles */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; scroll-behavior: smooth; }
        
        .msg { position: relative; padding: 10px 16px; border-radius: 22px; max-width: 75%; font-size: 15px; line-height: 1.4; animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .me { align-self: flex-end; background: var(--ig-grad); color: white; margin-bottom: 2px; border-bottom-right-radius: 4px; }
        .them { align-self: flex-start; background: #262626; color: white; margin-bottom: 2px; border-bottom-left-radius: 4px; }

        /* Input area - Instagram Styled */
        .footer { padding: 10px 15px 30px; background: #000; }
        .input-wrap { background: #262626; border-radius: 30px; display: flex; align-items: center; padding: 5px 15px; border: 1px solid #363636; }
        
        #in { flex: 1; background: none; border: none; color: white; padding: 10px 5px; font-size: 16px; outline: none; }
        #send-btn { color: #0095f6; font-weight: 700; background: none; border: none; font-size: 14px; padding-left: 10px; cursor: pointer; }

        /* Fullscreen Viewer */
        #viewer { display: none; position: fixed; inset: 0; background: #000; z-index: 5000; justify-content: center; align-items: center; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        #viewer img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Media Grid Styles */
        .img-msg { width: 100%; border-radius: 18px; margin-top: 5px; cursor: pointer; transition: 0.2s; }
        .img-msg:active { transform: scale(0.98); opacity: 0.9; }
    </style>
</head>
<body>

    <div id="lock">
        <input type="password" id="pin" placeholder="â€¢â€¢â€¢â€¢" maxlength="6">
    </div>

    <div class="header">
        <button class="nav-icon" onclick="startCall()">ðŸ“ž</button>
        <button class="nav-icon" onclick="exportData()">ðŸ“¥</button>
    </div>

    <div id="chat"></div>

    <div class="footer">
        <div class="input-wrap">
            <button onclick="document.getElementById('file-up').click()" style="color:white; font-size:20px; background:none; border:none; margin-right:10px;">ðŸ“·</button>
            <input type="file" id="file-up" hidden accept="image/*" onchange="upload(this)">
            <input type="text" id="in" placeholder="Message..." autocomplete="off">
            <button id="send-btn" onmousedown="event.preventDefault(); sendMsg();">Send</button>
        </div>
    </div>

    <div id="viewer" onclick="this.style.display='none'"></div>

    <script>
        const PIN_CODE = "112011";
        const MY_USER = "pig-2026"; 
        const PEER_USER = (MY_USER === "pig-2026") ? "rasmalai-2026" : "pig-2026";
        
        let db;
        const peer = new Peer(MY_USER);
        const inputField = document.getElementById('in');

        // IndexedDB for Zero-Gallery Storage
        const req = indexedDB.open("InstaVault", 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore("msgs", { keyPath: "id", autoIncrement: true });
        req.onsuccess = e => { db = e.target.result; };

        // Stealth Lock Logic
        document.getElementById('pin').addEventListener('input', (e) => {
            if(e.target.value === PIN_CODE) {
                document.getElementById('lock').style.opacity = '0';
                setTimeout(() => { document.getElementById('lock').style.display = 'none'; }, 500);
                loadMessages();
            }
        });

        // 1-Tap Calling
        peer.on('call', async call => {
            const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            // (Insert call UI logic here as per previous versions)
            call.answer(stream);
        });

        async function sendMsg() {
            const txt = inputField.value;
            if(!txt) return;

            const tx = db.transaction("msgs", "readwrite");
            tx.objectStore("msgs").add({ type: 'text', data: txt, sender: 'me', time: Date.now() });
            
            inputField.value = '';
            // KEYBOARD TRICK: Refocus instantly
            inputField.focus();
            
            tx.oncomplete = loadMessages;
        }

        function upload(el) {
            const reader = new FileReader();
            reader.onload = e => {
                const tx = db.transaction("msgs", "readwrite");
                tx.objectStore("msgs").add({ type: 'img', data: e.target.result, sender: 'me', time: Date.now() });
                tx.oncomplete = loadMessages;
                inputField.focus(); // Keep keyboard open
            };
            reader.readAsDataURL(el.files[0]);
        }

        function loadMessages() {
            const chat = document.getElementById('chat');
            chat.innerHTML = '';
            db.transaction("msgs").objectStore("msgs").getAll().onsuccess = e => {
                e.target.result.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `msg ${m.sender === 'me' ? 'me' : 'them'}`;
                    if(m.type === 'text') {
                        div.innerText = m.data;
                    } else {
                        div.innerHTML = `<img src="${m.data}" class="img-msg" onclick="fullView('${m.data}')">`;
                    }
                    chat.appendChild(div);
                });
                chat.scrollTop = chat.scrollHeight;
            };
        }

        function fullView(src) {
            const v = document.getElementById('viewer');
            v.innerHTML = `<img src="${src}">`;
            v.style.display = 'flex';
        }

        // Handle ENTER key without closing keyboard
        inputField.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                sendMsg();
            }
        });
    </script>
</body>
</html>
